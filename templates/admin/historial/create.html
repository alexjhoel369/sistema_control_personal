{% extends 'admin/base.html' %}

{% block title %}Registrar Historial Laboral{% endblock %}

{% block content %}
<h1 class="mb-4">Registrar Historial Laboral</h1>

<form method="POST" action="{{ url_for('historial.create') }}">
    <div class="form-group">
        <label for="empleado_id">Empleado</label>
        <select name="empleado_id" id="empleado_id" class="form-control" required>
            <option value="">Seleccione un empleado</option>
            {% for empleado in empleados %}
            <option value="{{ empleado.id }}">{{ empleado.nombre }}</option>
            {% endfor %}
        </select>
        <div id="detalles-empleado" class="mt-3"></div>
    </div>

    <!-- Botón para imprimir historial del empleado -->
    <div class="form-group">
        <a id="btn-imprimir" href="#" target="_blank" class="btn btn-info mt-2" style="display:none;">
            Imprimir historial del empleado
        </a>
    </div>

    <div class="form-group">
        <label for="fecha_inicio">Fecha Inicio</label>
        <input type="date" name="fecha_inicio" id="fecha_inicio" class="form-control" required>
    </div>

    <div class="form-group">
        <label for="fecha_fin">Fecha Fin (opcional)</label>
        <input type="date" name="fecha_fin" id="fecha_fin" class="form-control">
    </div>

    <button type="submit" class="btn btn-primary">Guardar</button>
    <a href="{{ url_for('historial.index') }}" class="btn btn-secondary">Cancelar</a>
</form>

<!-- Script para llenar datos del empleado y actualizar cargo + botón imprimir -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const empleadoSelect = document.getElementById('empleado_id');
        const detallesDiv = document.getElementById('detalles-empleado');
        const imprimirBtn = document.getElementById('btn-imprimir');

        empleadoSelect.addEventListener('change', function () {
            const empleadoId = this.value;
            if (empleadoId) {
                fetch(`/historiales/empleado/${empleadoId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.error) {
                            detallesDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                            imprimirBtn.style.display = 'none';
                        } else {
                            detallesDiv.innerHTML = `
                                <div class="card mt-3 p-3 bg-light border">
                                    <p><strong>Nombre:</strong> ${data.nombre} ${data.apellido}</p>
                                    <p><strong>CI:</strong> ${data.ci}</p>
                                    <p><strong>Email:</strong> ${data.email}</p>
                                    <p><strong>Teléfono:</strong> ${data.telefono}</p>
                                    <p><strong>Fecha Registro:</strong> ${data.fecha}</p>
                                    <p><strong>Cargo:</strong> ${data.cargo}</p>
                                    <p><strong>Usuarios:</strong> ${data.usuarios.join(', ')}</p>
                                </div>
                            `;
                            imprimirBtn.href = `/historiales/imprimir/${empleadoId}`;
                            imprimirBtn.style.display = 'inline-block';
                        }
                    });
            } else {
                detallesDiv.innerHTML = '';
                imprimirBtn.style.display = 'none';
            }
        });
    });
</script>


{% endblock %}
